{% extends 'base.html' %}
{% block title %}Reportes{% endblock %}
{% block content %}
<h1 class="text-2xl font-semibold mb-4">Reportes</h1>
<div class="grid md:grid-cols-4 gap-3 mb-4">
  <a href="{{ url_for('account_statement_clients') }}" class="card p-3 hover:bg-blue-50 transition-colors">
    <div class="text-sm font-semibold text-blue-700">Estados de cuenta</div>
    <div class="text-xs text-gray-500">Ver balances por cliente</div>
  </a>
  <a href="{{ url_for('export_history') }}" class="card p-3 hover:bg-gray-100 transition-colors">
    <div class="text-sm font-semibold text-gray-700">Historial de exportaciones</div>
    <div class="text-xs text-gray-500">Revisar archivos generados</div>
  </a>
  <a href="{{ url_for('export_inventory') }}" class="card p-3 hover:bg-emerald-50 transition-colors">
    <div class="text-sm font-semibold text-emerald-700">Exportar inventario</div>
    <div class="text-xs text-gray-500">Descargar stock actual en CSV</div>
  </a>
  <a href="{{ url_for('products') }}" class="card p-3 hover:bg-violet-50 transition-colors">
    <div class="text-sm font-semibold text-violet-700">Ir a productos</div>
    <div class="text-xs text-gray-500">Gestionar catálogo y precios</div>
  </a>
</div>

<form id="filters" class="card mb-6 grid md:grid-cols-5 gap-4" method="get" action="{{ url_for('reportes') }}">
  <div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha inicio</label>
    <input type="date" name="fecha_inicio" value="{{ filters.fecha_inicio }}" class="input">
  </div>
  <div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha fin</label>
    <input type="date" name="fecha_fin" value="{{ filters.fecha_fin }}" class="input">
  </div>
  <div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Estado de factura</label>
    <select name="estado" class="input">
      <option value="">Todos los estados</option>
      {% for s in statuses %}
      <option value="{{ s }}" {% if filters.estado==s %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
    <select name="categoria" class="input">
      <option value="">Todas las categorías</option>
      {% for c in categories %}
      <option value="{{ c }}" {% if filters.categoria==c %}selected{% endif %}>{{ c }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="relative">
    <label class="block text-sm font-medium text-gray-700 mb-1">Exportación</label>
    <select id="exportTipo" class="input mb-2">
      <option value="detalle">Detalle</option>
      <option value="resumen">Resumen</option>
    </select>
    <button type="button" id="exportBtn" class="btn w-full">Exportar</button>
    <div id="exportMenu" class="absolute right-0 mt-2 w-40 bg-white border rounded shadow hidden z-10">
      <a href="#" data-format="csv" class="block px-4 py-2 hover:bg-gray-100">CSV</a>
      <a href="#" data-format="xlsx" class="block px-4 py-2 hover:bg-gray-100">Excel</a>
      <a href="#" data-format="pdf" class="block px-4 py-2 hover:bg-gray-100">PDF</a>
    </div>
  </div>
  <div class="md:col-span-5 mt-2">
    <div class="flex flex-wrap items-center gap-2 rounded-lg border border-gray-200 bg-gray-50 p-3">
      <button class="btn-primary" type="submit">Aplicar filtros</button>
      <button class="btn-secondary" type="button" id="resetFilters">Limpiar filtros</button>
      <div class="h-6 w-px bg-gray-300 mx-1"></div>
      <div class="flex flex-wrap gap-1">
        <button type="button" data-range="today" class="btn-secondary text-xs">Hoy</button>
        <button type="button" data-range="7" class="btn-secondary text-xs">Últimos 7 días</button>
        <button type="button" data-range="month" class="btn-secondary text-xs">Este mes</button>
        <button type="button" data-range="year" class="btn-secondary text-xs">Este año</button>
      </div>
      <div class="h-6 w-px bg-gray-300 mx-1"></div>
      <a href="{{ url_for('inventory_report') }}" class="btn-secondary">Ver inventario</a>
      <a href="{{ url_for('export_history') }}" class="btn-secondary ml-auto">Ver historial</a>
      <span id="exportSpinner" class="hidden items-center text-sm text-gray-600">Generando...</span>
    </div>
  </div>
</form>

<div class="grid md:grid-cols-4 gap-4 mb-6">
  <div class="card text-center">
    <div class="text-sm text-gray-500">Ventas Totales</div>
    <div class="text-2xl font-bold">{{ stats.total_sales | money }}</div>
  </div>
  <div class="card text-center">
    <div class="text-sm text-gray-500">Clientes Únicos</div>
    <div class="text-2xl font-bold">{{ stats.unique_clients }}</div>
  </div>
  <div class="card text-center">
    <div class="text-sm text-gray-500">Facturas</div>
    <div class="text-2xl font-bold">{{ stats.invoices }}</div>
  </div>
  <div class="card text-center">
    <div class="text-sm text-gray-500">Pendientes</div>
    <div class="text-2xl font-bold">{{ stats.pending | money }}</div>
  </div>
  <div class="card text-center">
    <div class="text-sm text-gray-500">Pagadas</div>
    <div class="text-2xl font-bold">{{ stats.paid | money }}</div>
  </div>
  <div class="card text-center">
    <div class="text-sm text-gray-500">Efectivo</div>
    <div class="text-2xl font-bold">{{ stats.cash | money }}</div>
  </div>
  <div class="card text-center">
    <div class="text-sm text-gray-500">Transferencias</div>
    <div class="text-2xl font-bold">{{ stats.transfer | money }}</div>
  </div>
  <div class="card text-center">
    <div class="text-sm text-gray-500">Ticket Promedio</div>
    <div class="text-2xl font-bold">{{ stats.avg_ticket | money }}</div>
  </div>
  <div class="card text-center">
    <div class="text-sm text-gray-500">Ticket Prom. Mes</div>
    <div class="text-2xl font-bold">{{ stats.avg_ticket_month | money }}</div>
  </div>
  <div class="card text-center">
    <div class="text-sm text-gray-500">Ticket Prom. Año</div>
    <div class="text-2xl font-bold">{{ stats.avg_ticket_year | money }}</div>
  </div>
  <div class="card text-center">
    <div class="text-sm text-gray-500">Retención</div>
    <div class="text-2xl font-bold">{{ '%.1f%%'|format(stats.retention) }}</div>
  </div>
  <div class="card text-center">
    <div class="text-sm text-gray-500">ITBIS acumulado</div>
    <div class="text-2xl font-bold">{{ stats.itbis_accumulated | money }}</div>
    {% set itbis_change = kpi_changes.itbis_accumulated %}
    <div class="mt-1 text-xs font-semibold {% if itbis_change is none %}text-gray-500{% elif itbis_change >= 0 %}text-emerald-600{% else %}text-red-600{% endif %}">
      {% if itbis_change is none %}N/D{% elif itbis_change >= 0 %}+{{ '%.1f'|format(itbis_change) }}%{% else %}{{ '%.1f'|format(itbis_change) }}%{% endif %}
    </div>
  </div>
  <div class="card text-center">
    <div class="text-sm text-gray-500">Ventas sin ITBIS</div>
    <div class="text-2xl font-bold">{{ stats.net_sales | money }}</div>
    {% set net_change = kpi_changes.net_sales %}
    <div class="mt-1 text-xs font-semibold {% if net_change is none %}text-gray-500{% elif net_change >= 0 %}text-emerald-600{% else %}text-red-600{% endif %}">
      {% if net_change is none %}N/D{% elif net_change >= 0 %}+{{ '%.1f'|format(net_change) }}%{% else %}{{ '%.1f'|format(net_change) }}%{% endif %}
    </div>
  </div>
  <div class="card text-center">
    <div class="text-sm text-gray-500">Ganancia estimada (con costo cargado)</div>
    <div class="text-2xl font-bold">{{ stats.estimated_profit_with_cost | money }}</div>
    {% set profit_change = kpi_changes.estimated_profit_with_cost %}
    <div class="mt-1 text-xs font-semibold {% if profit_change is none %}text-gray-500{% elif profit_change >= 0 %}text-emerald-600{% else %}text-red-600{% endif %}">
      {% if profit_change is none %}N/D{% elif profit_change >= 0 %}+{{ '%.1f'|format(profit_change) }}%{% else %}{{ '%.1f'|format(profit_change) }}%{% endif %}
    </div>
  </div>
  <div class="card text-center">
    <div class="text-sm text-gray-500">Ventas sin costo registrado</div>
    <div class="text-2xl font-bold">{{ stats.revenue_without_cost_data | money }}</div>
    <p class="text-xs text-gray-500 mt-1">Estas ventas no se incluyen en la ganancia estimada.</p>
  </div>
</div>

<div class="grid gap-6 mb-6 md:grid-cols-2">
  <div class="card p-4">
    <h3 class="text-sm mb-2 text-center">Ventas por categoría</h3>
    <div class="relative w-full h-72">
      <canvas id="catChart"></canvas>
    </div>
  </div>
  <div class="card p-4">
    <h3 class="text-sm mb-2 text-center">Ventas en el tiempo</h3>
    <div class="relative w-full h-72">
      <canvas id="timeChart"></canvas>
    </div>
  </div>
</div>
<div class="grid gap-6 mb-6 md:grid-cols-3">
  <div class="card p-4">
    <h3 class="text-sm mb-2 text-center">Estado de facturas</h3>
    <div class="relative w-full h-72">
      <canvas id="statusChart"></canvas>
    </div>
  </div>
  <div class="card p-4">
    <h3 class="text-sm mb-2 text-center">Ventas por mes</h3>
    <div class="relative w-full h-72">
      <canvas id="monthlyChart"></canvas>
    </div>
  </div>
  <div class="card p-4">
    <h3 class="text-sm mb-2 text-center">Métodos de pago</h3>
    <div class="relative w-full h-72">
      <canvas id="methodChart"></canvas>
    </div>
  </div>
</div>
<div class="card p-4 mb-6">
  <h3 class="text-sm mb-2 text-center">Tendencia 24 meses</h3>
  <div class="relative w-full h-72">
    <canvas id="trendChart"></canvas>
  </div>
</div>

<div class="card overflow-x-auto mb-6">
  <h2 class="text-xl font-semibold mb-2">Ventas por Categoría</h2>
  <table class="min-w-full text-sm">
    <thead class="bg-gray-100">
      <tr>
        <th class="p-2 text-left">Categoría</th>
        <th class="p-2 text-right">Cantidad</th>
        <th class="p-2 text-right">Promedio</th>
        <th class="p-2 text-right">Total</th>
      </tr>
    </thead>
    <tbody>
      {% if sales_by_category %}
      {% for cat, qty, avg, total in sales_by_category %}
      <tr class="border-t">
        <td class="p-2">{{ cat or 'Sin categoría' }}</td>
        <td class="p-2 text-right">{{ qty }}</td>
        <td class="p-2 text-right">{{ avg | money }}</td>
        <td class="p-2 text-right">{{ total | money }}</td>
      </tr>
      {% endfor %}
      {% else %}
      <tr class="border-t"><td class="p-2 text-center" colspan="4">Sin datos</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<div class="card overflow-x-auto mb-6">
  <h2 class="text-xl font-semibold mb-2">Top 5 Clientes</h2>
  <table class="min-w-full text-sm">
    <thead class="bg-gray-100">
      <tr>
        <th class="p-2 text-left">Cliente</th>
        <th class="p-2 text-right">Total</th>
      </tr>
    </thead>
    <tbody>
      {% if top_clients %}
      {% for name, total in top_clients %}
      <tr class="border-t">
        <td class="p-2">{{ name }}</td>
        <td class="p-2 text-right">{{ total | money }}</td>
      </tr>
      {% endfor %}
      {% else %}
      <tr class="border-t"><td class="p-2 text-center" colspan="2">Sin datos</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<div class="card overflow-x-auto">
  <h2 class="text-xl font-semibold mb-2">Detalle de Facturas</h2>
  <table class="min-w-full text-sm">
    <thead class="bg-gray-100">
      <tr>
        <th class="p-2 text-left">Cliente</th>
        <th class="p-2 text-left">Fecha</th>
        <th class="p-2 text-left">Estado</th>
        <th class="p-2 text-right">Total</th>
      </tr>
    </thead>
    <tbody>
      {% if invoices %}
      {% for inv in invoices %}
      <tr class="border-t">
        <td class="p-2">{{ inv.client.name }}</td>
        <td class="p-2">{{ inv.date.strftime('%Y-%m-%d') }}</td>
        <td class="p-2">{{ inv.status }}</td>
        <td class="p-2 text-right">{{ inv.total | money }}</td>
      </tr>
      {% endfor %}
      {% else %}
      <tr class="border-t"><td class="p-2 text-center" colspan="4">Sin datos</td></tr>
      {% endif %}
    </tbody>
  </table>
  <div class="flex justify-end gap-2 mt-2">
    {% if pagination.page > 1 %}
    <a class="btn" href="{{ url_for('reportes', page=pagination.page-1, **filters) }}">Anterior</a>
    {% endif %}
    {% if pagination.page < pagination.pages %}
    <a class="btn" href="{{ url_for('reportes', page=pagination.page+1, **filters) }}">Siguiente</a>
    {% endif %}
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const currency = new Intl.NumberFormat('es-DO',{style:'currency',currency:'DOP'});

const catCtx = document.getElementById('catChart');
const catChart = new Chart(catCtx, {
  type: 'pie',
  data: {
    labels: {{ cat_labels|tojson }},
    datasets: [{ data: {{ cat_totals|tojson }}, backgroundColor:['#1e3a8a','#3b82f6','#60a5fa','#93c5fd','#cbd5e1'] }]
  },
  options:{
    responsive:true,
    maintainAspectRatio:false,
    plugins:{
      tooltip:{
        callbacks:{
          label: ctx => {
            const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
            const pct = total? (ctx.parsed/total*100).toFixed(1):0;
            return `${ctx.label}: ${currency.format(ctx.parsed)} (${pct}%)`;
          }
        }
      }
    }
  }
});
catCtx.onclick = function(evt){
  const points = catChart.getElementsAtEventForMode(evt,'nearest',{intersect:true},true);
  if(points.length){
    const label = catChart.data.labels[points[0].index];
    const params = new URLSearchParams(new FormData(document.getElementById('filters')));
    params.set('categoria', label);
    window.location = '?' + params.toString();
  }
};

const timeCtx = document.getElementById('timeChart');
const dateCounts = {{ date_counts|tojson }};
new Chart(timeCtx, {
  type: 'line',
  data: {
    labels: {{ date_labels|tojson }},
    datasets: [{ label: 'Ventas en el tiempo', data: {{ date_totals|tojson }}, borderColor: '#1e3a8a', fill:false, count: dateCounts }]
  },
  options: {
    responsive:true,
    maintainAspectRatio:false,
    plugins: {
      tooltip: {
        callbacks: {
          label: ctx => `${currency.format(ctx.parsed.y)} (${ctx.dataset.count[ctx.dataIndex]} ventas)`
        }
      }
    }
  }
});

const statusCtx = document.getElementById('statusChart');
const statusChart = new Chart(statusCtx, {
  type: 'pie',
  data: {labels: {{ status_labels|tojson }}, datasets: [{data: {{ status_values|tojson }}, backgroundColor:['#1e3a8a','#facc15','#16a34a']} ]},
  options:{responsive:true, maintainAspectRatio:false}
});
statusCtx.onclick = function(evt){
  const points = statusChart.getElementsAtEventForMode(evt,'nearest',{intersect:true},true);
  if(points.length){
    const label = statusChart.data.labels[points[0].index];
    const params = new URLSearchParams(new FormData(document.getElementById('filters')));
    params.set('estado', label);
    window.location = '?' + params.toString();
  }
};

const monthlyCtx = document.getElementById('monthlyChart');
new Chart(monthlyCtx, {
  type: 'bar',
  data: {
    labels: {{ months|tojson }},
    datasets: [
      {label: 'Año actual', data: {{ year_current|tojson }}, backgroundColor:'#1e3a8a'},
      {label: 'Año anterior', data: {{ year_prev|tojson }}, backgroundColor:'#93c5fd'}
    ]
  },
  options:{responsive:true, maintainAspectRatio:false}
});

const trendCtx = document.getElementById('trendChart');
new Chart(trendCtx, {
  type: 'line',
  data: {
    labels: {{ (trend_24|default([], true))|map(attribute='month', default='')|list|tojson }},
    datasets: [{label:'Últimos 24 meses', data: {{ (trend_24|default([], true))|map(attribute='total', default=0)|list|tojson }}, borderColor:'#1e3a8a', fill:false}]
  },
  options:{responsive:true, maintainAspectRatio:false}
});

const methodCtx = document.getElementById('methodChart');
new Chart(methodCtx, {
  type: 'pie',
  data:{labels: {{ method_labels|tojson }}, datasets:[{data: {{ method_values|tojson }}, backgroundColor:['#4ade80','#60a5fa']}]},
  options:{responsive:true, maintainAspectRatio:false}
});

const exportBtn = document.getElementById('exportBtn');
const exportMenu = document.getElementById('exportMenu');
const spinner = document.getElementById('exportSpinner');
const exportTipo = document.getElementById('exportTipo');
exportBtn.addEventListener('click', () => exportMenu.classList.toggle('hidden'));
exportMenu.querySelectorAll('a').forEach(a => {
  a.addEventListener('click', async e => {
    e.preventDefault();
    spinner.classList.remove('hidden');
    const params = new URLSearchParams(new FormData(document.getElementById('filters')));
    const base = `{{ url_for('export_reportes') }}?formato=${a.dataset.format}&tipo=${exportTipo.value}&`;
    let resp = await fetch(base + params.toString());
    if (resp.status === 400) {
      const data = await resp.json();
      if (data.suggest === 'async') {
        resp = await fetch(base + params.toString() + '&async=1');
      }
    }
    spinner.classList.add('hidden');
    if (resp.headers.get('content-type')?.includes('application/json')) {
      const data = await resp.json();
      if (data.job) {
        alert('Reporte en proceso, revise el historial de exportaciones.');
      } else if (data.error) {
        alert(data.error);
      }
    } else {
      const blob = await resp.blob();
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `reportes.${a.dataset.format}`;
      document.body.appendChild(link);
      link.click();
      link.remove();
      window.URL.revokeObjectURL(url);
    }
    exportMenu.classList.add('hidden');
  });
});

document.getElementById('resetFilters').addEventListener('click', () => {
  window.location = '{{ url_for('reportes') }}';
});
document.querySelectorAll('[data-range]').forEach(btn => {
  btn.addEventListener('click', () => {
    const end = new Date();
    let start = new Date();
    const range = btn.dataset.range;
    if (range === '7') {
      start.setDate(start.getDate() - 6);
    } else if (range === 'month') {
      start = new Date(start.getFullYear(), start.getMonth(), 1);
    } else if (range === 'year') {
      start = new Date(start.getFullYear(), 0, 1);
    }
    const fmt = d => d.toISOString().slice(0,10);
    document.querySelector('input[name="fecha_inicio"]').value = fmt(start);
    document.querySelector('input[name="fecha_fin"]').value = fmt(end);
  });
});

document.getElementById('filters').addEventListener('submit', () => {
  spinner.classList.remove('hidden');
});
</script>
{% endblock %}

{% extends 'base.html' %}
{% block title %}Productos{% endblock %}
{% block content %}
<h1 class="text-2xl font-semibold mb-4">Productos</h1>
<div class="mb-4 flex flex-wrap gap-2">
  <a href="{{ url_for('products_import') }}" class="btn-secondary">Importar CSV</a>
  <a href="{{ url_for('export_products', cat=current_cat) }}" class="btn-secondary">Exportar productos</a>
  <a href="{{ url_for('product_price_history') }}" class="btn-secondary">Historial de precios</a>
</div>
<form method="post" class="card mb-6 space-y-4">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <p class="text-sm text-gray-600">
    Si activa <strong>Usar costo</strong>, el costo debe ser mayor que 0. El sistema mostrará advertencias cuando el margen sea bajo o negativo.
  </p>
  <div class="grid md:grid-cols-8 gap-4 items-center">
    <input id="name" name="name" placeholder="Nombre" class="input" required>
    <select name="unit" class="input" required>
      {% for u in units %}<option value="{{ u }}">{{ u }}</option>{% endfor %}
    </select>
    <input name="code" placeholder="Código" class="input" required>
    <input id="reference" name="reference" placeholder="Referencia" class="input" readonly>
    <input name="price" placeholder="Precio" class="input" required>
    <div class="space-y-1">
      <label class="flex items-center space-x-2 text-sm text-gray-700">
        <input type="checkbox" id="use-cost" name="use_cost">
        <span>Usar costo</span>
      </label>
      <input id="cost-price" name="cost_price" placeholder="Costo" class="input" disabled>
      <p id="margin-preview" class="text-xs text-gray-500">Margen: —</p>
    </div>
    <select name="category" class="input" required>
      {% for c in categories %}<option value="{{ c }}">{{ c }}</option>{% endfor %}
    </select>
    <label class="flex items-center space-x-2">
      <input type="checkbox" name="has_itbis" checked>
      <span>ITBIS</span>
    </label>
  </div>
  <button class="btn-primary">Agregar</button>
</form>

<form method="get" class="mb-4 flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0">
  <select name="cat" class="input">
    <option value="">Todas las categorías</option>
    {% for c in categories %}
    <option value="{{ c }}" {% if current_cat == c %}selected{% endif %}>{{ c }}</option>
    {% endfor %}
  </select>
  <button class="btn-secondary">Filtrar</button>
</form>

<div class="card overflow-x-auto">
  <table class="min-w-full text-sm">
    <thead class="bg-gray-100">
      <tr>
        <th class="p-2 text-left">Código</th>
        <th class="p-2 text-left">Referencia</th>
        <th class="p-2 text-left">Nombre</th>
        <th class="p-2 text-left">Unidad</th>
        <th class="p-2 text-left">Precio</th>
        <th class="p-2 text-left">Costo</th>
        <th class="p-2 text-left">Margen</th>
        <th class="p-2 text-left">Categoría</th>
        <th class="p-2 text-left">ITBIS</th>
        <th class="p-2 text-left">Acciones</th>
      </tr>
    </thead>
    <tbody>
    {% for p in products %}
      <tr class="border-t">
        <td class="p-2">{{ p.code }}</td>
        <td class="p-2">{{ p.reference }}</td>
        <td class="p-2">{{ p.name }}</td>
        <td class="p-2">{{ p.unit }}</td>
        <td class="p-2">{{ p.price | money }}</td>
        <td class="p-2">{{ p.cost_price | money if p.cost_price is not none else '-' }}</td>
        <td class="p-2">
          {% if p.cost_price and p.cost_price > 0 %}
            {{ '%.1f'|format(((p.price - p.cost_price) / p.cost_price) * 100) }}%
          {% else %}
            -
          {% endif %}
        </td>
        <td class="p-2">{{ p.category }}</td>
        <td class="p-2">{{ 'Sí' if p.has_itbis else 'No' }}</td>
        <td class="p-2 space-x-2">
          <a class="text-blue-500" href="{{ url_for('edit_product', product_id=p.id) }}">Editar</a>
          <a class="text-red-500" href="{{ url_for('delete_product', product_id=p.id) }}">Eliminar</a>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('name').addEventListener('blur', async function(){
  const name = this.value;
  if(!name) return;
  const res = await fetch('/api/reference?name=' + encodeURIComponent(name));
  const data = await res.json();
  document.getElementById('reference').value = data.reference;
});

const useCost=document.getElementById('use-cost');
const costField=document.getElementById('cost-price');
const priceField=document.querySelector('input[name="price"]');
const marginPreview=document.getElementById('margin-preview');

function renderMargin(){
  if(!useCost.checked){
    marginPreview.textContent='Margen: —';
    return;
  }
  const cost=parseFloat(costField.value)||0;
  const price=parseFloat(priceField.value)||0;
  if(cost<=0){
    marginPreview.textContent='Margen: defina costo mayor que 0';
    return;
  }
  const margin=((price-cost)/cost)*100;
  marginPreview.textContent=`Margen: ${margin.toFixed(1)}%`;
}

useCost.addEventListener('change',()=>{
  costField.disabled=!useCost.checked;
  if(!useCost.checked){
    costField.value='';
  }
  renderMargin();
});
costField.addEventListener('input',renderMargin);
priceField.addEventListener('input',renderMargin);
</script>
{% endblock %}

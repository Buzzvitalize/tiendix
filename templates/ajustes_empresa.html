{% extends 'base.html' %}
{% block title %}Ajustes - Empresa{% endblock %}
{% block content %}
{% set is_manager = session.get('role')=='manager' %}
<h1 class="text-2xl font-semibold mb-4">Ajustes</h1>
<div class="mb-4 space-x-4">
  <a href="{{ url_for('settings_company') }}" class="btn-secondary">Empresa</a>
  <a href="{{ url_for('settings_add_user') }}" class="btn-secondary">Agregar Usuarios</a>
  <a href="{{ url_for('settings_manage_users') }}" class="btn-secondary">Gestionar Usuarios</a>
</div>
<form method="post" enctype="multipart/form-data" class="card space-y-4 max-w-4xl mx-auto" data-unsaved-guard="1">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <div class="grid md:grid-cols-2 gap-4">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Nombre comercial</label>
      <input name="name" value="{{ company.name }}" placeholder="Nombre" class="input" {% if is_manager %}disabled{% else %}required{% endif %}>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">RNC</label>
      <input name="rnc" value="{{ company.rnc }}" placeholder="RNC" class="input id-mask" data-doc-type="rnc" {% if is_manager %}disabled{% endif %}>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
      <input name="phone" value="{{ company.phone }}" placeholder="Teléfono" class="input phone-mask" {% if is_manager %}disabled{% endif %}>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Sitio web</label>
      <input name="website" value="{{ company.website }}" placeholder="Sitio Web" class="input" {% if is_manager %}disabled{% endif %}>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Correo del propietario</label>
      <input name="owner_email" value="{{ owner_email or '' }}" class="input bg-gray-100" readonly>
      <p class="text-xs text-gray-500 mt-1">Solo visualización. Este correo no se puede cambiar desde ajustes.</p>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Calle</label>
      <input name="street" value="{{ company.street }}" placeholder="Calle" class="input" {% if is_manager %}disabled{% endif %}>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Sector</label>
      <input name="sector" value="{{ company.sector }}" placeholder="Sector" class="input" {% if is_manager %}disabled{% endif %}>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Provincia</label>
      <input name="province" value="{{ company.province }}" placeholder="Provincia" class="input" {% if is_manager %}disabled{% endif %}>
    </div>
    <div class="space-y-2">
      <label for="logo-input" class="block text-sm font-medium text-gray-700">Logo</label>
      <input type="file" name="logo" id="logo-input" class="input">
      <img id="logo-preview" src="{% if company.logo %}{{ url_for('static', filename=company.logo) }}{% endif %}" class="h-16"/>
      {% if company.logo %}
      <button name="remove_logo" value="1" class="btn-secondary" onclick="return confirm('¿Eliminar logo?')">Eliminar logo</button>
      {% endif %}
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">NCF Consumidor Final</label>
      <input name="ncf_final" value="{{ company.ncf_final }}" placeholder="NCF Consumidor Final" class="input">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">NCF Comprobante Fiscal</label>
      <input name="ncf_fiscal" value="{{ company.ncf_fiscal }}" placeholder="NCF Comprobante Fiscal" class="input">
    </div>
  </div>
  <button class="btn-primary">Guardar</button>
</form>
{% endblock %}
{% block scripts %}
<script>
const input=document.getElementById('logo-input');
const preview=document.getElementById('logo-preview');
const settingsForm = document.querySelector('form[data-unsaved-guard="1"]');
let hasUnsavedChanges = false;
let isSubmitting = false;

if(input){
  input.addEventListener('change', e=>{
    const file=e.target.files[0];
    hasUnsavedChanges = true;
    if(file){
      const reader=new FileReader();
      reader.onload=ev=>{preview.src=ev.target.result;};
      reader.readAsDataURL(file);
    }
  });
}

if (settingsForm) {
  settingsForm.querySelectorAll('input, select, textarea').forEach((el) => {
    if (el.type === 'hidden') return;
    el.addEventListener('input', () => { hasUnsavedChanges = true; });
    el.addEventListener('change', () => { hasUnsavedChanges = true; });
  });

  settingsForm.addEventListener('submit', () => {
    isSubmitting = true;
    hasUnsavedChanges = false;
  });

  window.addEventListener('beforeunload', (event) => {
    if (!hasUnsavedChanges || isSubmitting) return;
    event.preventDefault();
    event.returnValue = '';
  });

  document.querySelectorAll('a[href]').forEach((link) => {
    link.addEventListener('click', (event) => {
      if (!hasUnsavedChanges || isSubmitting) return;
      const ok = window.confirm('Aún no has guardado los cambios. ¿Deseas continuar? No se guardará nada.');
      if (!ok) {
        event.preventDefault();
      }
    });
  });
}
</script>
{% endblock %}

{% extends 'base.html' %}
{% block content %}
<h1 class="text-xl mb-4">Usuarios</h1>

<form method="get" class="mb-4 flex gap-2 items-end">
  <div class="flex-1">
    <label for="cpanel-user-search" class="block text-sm font-medium text-gray-700 mb-1">Buscar usuario</label>
    <input id="cpanel-user-search" name="q" value="{{ q }}" placeholder="Buscar" class="border p-1 rounded w-full">
  </div>
  <button class="bg-blue-600 text-white px-3 rounded">Buscar</button>
</form>

<table class="min-w-full bg-white">
  <thead>
    <tr class="bg-gray-100">
      <th class="p-2 text-left">Usuario</th>
      <th class="p-2 text-left">Datos</th>
      <th class="p-2 text-left">Rol</th>
      <th class="p-2 text-left">Credenciales</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
  {% for u in users.items %}
  <tr class="border-t">
    <td class="p-2">
      <div class="font-semibold">{{ u.username }}</div>
      <div class="text-xs text-gray-500">ID: {{ u.id }}</div>
      <a class="text-xs text-blue-700 hover:underline" href="{{ url_for('cpanel_user_activity', user_id=u.id) }}">Ver actividad</a>
    </td>
    <td class="p-2 text-sm">
      <div>{{ (u.first_name or '') ~ ' ' ~ (u.last_name or '') }}</div>
      <div class="text-gray-600">{{ u.email or 'Sin correo' }}</div>
      <div class="text-gray-500 text-xs">Empresa: {{ u.company_id or 'N/A' }}</div>
    </td>
    <td class="p-2">
      <form method="post" action="{{ url_for('cpanel_user_role', user_id=u.id) }}" class="flex gap-2">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div>
          <label for="role-{{u.id}}" class="block text-xs font-semibold text-gray-600 mb-1">Rol</label>
          <select id="role-{{u.id}}" name="role" class="border p-1 rounded">
          {% for r in ['admin','manager','company'] %}
          <option value="{{ r }}" {% if u.role==r %}selected{% endif %}>{{ r }}</option>
          {% endfor %}
          </select>
        </div>
        <button class="bg-blue-600 text-white px-2 rounded" type="submit">Guardar</button>
      </form>
    </td>
    <td class="p-2">
      <form method="post" action="{{ url_for('cpanel_user_update', user_id=u.id) }}" class="flex gap-2">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div>
          <label for="fname-{{u.id}}" class="block text-xs font-semibold text-gray-600 mb-1">Nombre</label>
          <input id="fname-{{u.id}}" name="first_name" value="{{ u.first_name or '' }}" placeholder="Nombre" class="border p-1 rounded">
        </div>
        <div>
          <label for="lname-{{u.id}}" class="block text-xs font-semibold text-gray-600 mb-1">Apellido</label>
          <input id="lname-{{u.id}}" name="last_name" value="{{ u.last_name or '' }}" placeholder="Apellido" class="border p-1 rounded">
        </div>
        <div>
          <label for="email-{{u.id}}" class="block text-xs font-semibold text-gray-600 mb-1">Correo</label>
          <input id="email-{{u.id}}" name="email" value="{{ u.email or '' }}" placeholder="Email" class="border p-1 rounded">
        </div>
        <div>
          <label for="password-{{u.id}}" class="block text-xs font-semibold text-gray-600 mb-1">Nueva contraseña</label>
          <input id="password-{{u.id}}" name="password" type="password" placeholder="Nueva contraseña" class="border p-1 rounded">
        </div>
        <button class="bg-blue-600 text-white px-2 rounded" type="submit">Actualizar</button>
      </form>
    </td>
    <td class="p-2">
      <form method="post" action="{{ url_for('cpanel_user_delete', user_id=u.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button class="text-red-600" onclick="return confirm('Eliminar?')">Eliminar</button>
      </form>
    </td>
  </tr>
  {% endfor %}
  </tbody>
</table>

<div class="mt-4 flex items-center gap-2">
  {% if users.has_prev %}
    <a href="?page={{ users.prev_num }}&q={{ q }}" class="px-2 py-1 bg-gray-200 rounded">Anterior</a>
  {% endif %}
  <span>Página {{ users.page }} de {{ users.pages }}</span>
  {% if users.has_next %}
    <a href="?page={{ users.next_num }}&q={{ q }}" class="px-2 py-1 bg-gray-200 rounded">Siguiente</a>
  {% endif %}
</div>
{% endblock %}

{% extends 'base.html' %}
{% block title %}Cotizaciones{% endblock %}
{% block content %}
<h1 class="text-2xl font-semibold mb-4">Cotizaciones</h1>
<a href="{{ url_for('new_quotation') }}" class="btn-primary inline-block mb-4">Nueva Cotizaci칩n</a>
<div class="max-w-4xl mx-auto space-y-3 mb-4">
  <form method="get" class="card p-4 flex flex-wrap items-end gap-2">
    <input type="hidden" name="status" value="{{ status or '' }}">
    <div>
      <label for="quotation-client-search" class="block text-sm font-medium text-gray-700 mb-1">Buscar cliente</label>
      <input id="quotation-client-search" name="client" value="{{ client or '' }}" placeholder="Nombre o identificador" class="input">
    </div>
    <div>
      <label for="quotation-date-from" class="block text-sm font-medium text-gray-700 mb-1">Desde</label>
      <input id="quotation-date-from" type="date" name="date_from" value="{{ date_from or '' }}" class="input">
    </div>
    <div>
      <label for="quotation-date-to" class="block text-sm font-medium text-gray-700 mb-1">Hasta</label>
      <input id="quotation-date-to" type="date" name="date_to" value="{{ date_to or '' }}" class="input">
    </div>
    <button class="btn-secondary">Buscar cotizaci칩n</button>
  </form>

  <form method="get" class="card p-4 flex flex-wrap items-end gap-2">
    <input type="hidden" name="client" value="{{ client or '' }}">
    <input type="hidden" name="date_from" value="{{ date_from or '' }}">
    <input type="hidden" name="date_to" value="{{ date_to or '' }}">
    <div>
      <label for="quotation-status" class="block text-sm font-medium text-gray-700 mb-1">Estado de cotizaci칩n</label>
      <select id="quotation-status" name="status" class="input">
        <option value="">Todos</option>
        <option value="vigente" {% if status=='vigente' %}selected{% endif %}>Vigentes</option>
        <option value="convertida" {% if status=='convertida' %}selected{% endif %}>Convertidas</option>
        <option value="vencida" {% if status=='vencida' %}selected{% endif %}>Vencidas</option>
      </select>
    </div>
    <button class="btn-secondary">Aplicar estado</button>
  </form>
</div>
<div class="card overflow-x-auto max-w-4xl mx-auto">
  {% if quotations.items %}
  <table class="min-w-full text-sm">
    <thead class="bg-gray-100">
      <tr>
        <th class="p-2 text-left">ID</th>
        <th class="p-2 text-left">Cliente</th>
        <th class="p-2 text-left">Fecha</th>
        <th class="p-2 text-left">Total</th>
        <th class="p-2 text-left">Estado</th>
        <th class="p-2 text-left">Acciones</th>
      </tr>
    </thead>
    <tbody>
    {% for q in quotations.items %}
      <tr class="border-t">
        <td class="p-2">{{ q.id }}</td>
        <td class="p-2">{{ q.client.name }}</td>
        <td class="p-2">{{ q.date.strftime('%d/%m/%Y %I:%M %p') }}</td>
        <td class="p-2">{{ q.total | money }}</td>
        <td class="p-2">{{ q.status }}</td>
        <td class="p-2 space-x-2">
          <button type="button" class="text-blue-500 inline-flex items-center gap-1 pdf-action" data-pdf-url="{{ url_for('quotation_pdf', quotation_id=q.id) }}" data-filename="cotizacion_{{ q.id }}.pdf">
            <span class="pdf-label">Generar PDF</span>
          </button>
          <form method="post" action="{{ url_for('send_quotation_email', quotation_id=q.id) }}" class="inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="text-indigo-500">Enviar</button>
          </form>
          <a class="text-yellow-500" href="{{ url_for('edit_quotation', quotation_id=q.id) }}">Editar</a>
          {% set expired = q.valid_until < now %}
          {% if expired %}
            <span class="text-gray-400">Crear Pedido</span>
          {% else %}
            <a class="text-green-500" href="{{ url_for('quotation_to_order', quotation_id=q.id) }}">Crear Pedido</a>
          {% endif %}
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="p-2">No se encontraron resultados.</p>
  {% endif %}
</div>
<div class="mt-4 flex items-center gap-2">
  {% if quotations.has_prev %}
  <a
    href="{{ url_for('list_quotations',
                     page=quotations.prev_num,
                     client=client,
                     date_from=date_from,
                     date_to=date_to,
                     status=status) }}"
    class="px-2 py-1 bg-gray-200 rounded">Anterior</a>
  {% endif %}
  <span>P치gina {{ quotations.page }} de {{ quotations.pages }}</span>
  {% if quotations.has_next %}
  <a
    href="{{ url_for('list_quotations',
                     page=quotations.next_num,
                     client=client,
                     date_from=date_from,
                     date_to=date_to,
                     status=status) }}"
    class="px-2 py-1 bg-gray-200 rounded">Siguiente</a>
  {% endif %}
</div>
{% endblock %}


{% block scripts %}
<script>
document.querySelectorAll('.pdf-action').forEach((btn) => {
  let blobUrl = null;
  let ready = false;

  function setLabel(label, icon = false) {
    btn.innerHTML = icon
      ? `<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v9m0 0l-3-3m3 3l3-3m-9 7h12"/></svg><span class="pdf-label">${label}</span>`
      : `<span class="pdf-label">${label}</span>`;
  }

  btn.addEventListener('click', async () => {
    if (ready && blobUrl) {
      const a = document.createElement('a');
      a.href = blobUrl;
      a.download = btn.dataset.filename || 'documento.pdf';
      document.body.appendChild(a);
      a.click();
      a.remove();
      return;
    }

    setLabel('Generando PDF...');
    btn.disabled = true;

    try {
      const resp = await fetch(btn.dataset.pdfUrl, { credentials: 'same-origin' });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const blob = await resp.blob();
      blobUrl = URL.createObjectURL(blob);
      ready = true;
      setLabel('Descargar PDF', true);
      btn.classList.remove('text-blue-500');
      btn.classList.add('text-green-600');
      btn.disabled = false;
    } catch (_err) {
      setLabel('Error PDF');
      btn.classList.remove('text-blue-500');
      btn.classList.add('text-red-600');
      btn.disabled = false;
    }
  });
});
</script>
{% endblock %}

{% extends 'base.html' %}
{% block title %}Clientes{% endblock %}
{% block content %}
<h1 class="text-2xl font-semibold mb-4">Clientes</h1>
<form method="get" class="mb-4 flex space-x-2 items-end">
  <div class="flex-1">
    <label for="clients-search" class="block text-sm font-medium text-gray-700 mb-1">Buscar cliente</label>
    <input id="clients-search" name="q" value="{{ q }}" placeholder="Buscar por nombre, identificador o email" class="input w-full">
  </div>
  <button class="btn-secondary">Buscar</button>
</form>
<form method="post" class="card mb-6 space-y-4">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <div class="grid md:grid-cols-2 gap-4">
    <div>
      <label for="client-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
      <input id="client-name" name="name" placeholder="Nombre" class="input" required>
    </div>
    <div id="last-name-wrapper">
      <label for="last_name" class="block text-sm font-medium text-gray-700 mb-1">Apellido</label>
      <input id="last_name" name="last_name" placeholder="Apellido" class="input">
    </div>
    <div>
      <label for="identifier" class="block text-sm font-medium text-gray-700 mb-1">Documento</label>
      <input name="identifier" placeholder="Cédula" class="input id-mask" id="identifier" data-doc-type="cedula">
    </div>
    <div>
      <label for="client-phone" class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
      <input id="client-phone" name="phone" placeholder="Teléfono" class="input phone-mask">
    </div>
    <div>
      <label for="client-email" class="block text-sm font-medium text-gray-700 mb-1">Correo electrónico</label>
      <input id="client-email" name="email" placeholder="Email" class="input">
    </div>
    <div>
      <label for="client-street" class="block text-sm font-medium text-gray-700 mb-1">Calle</label>
      <input id="client-street" name="street" placeholder="Calle" class="input">
    </div>
    <div>
      <label for="client-sector" class="block text-sm font-medium text-gray-700 mb-1">Sector</label>
      <input id="client-sector" name="sector" placeholder="Sector" class="input">
    </div>
    <div>
      <label for="client-province" class="block text-sm font-medium text-gray-700 mb-1">Provincia</label>
      <input id="client-province" name="province" placeholder="Provincia" class="input">
    </div>
  </div>
  <div class="flex space-x-4">
    <label><input type="radio" name="type" value="final" checked> Consumidor Final</label>
    <label><input type="radio" name="type" value="fiscal"> Empresa</label>
  </div>
  <button class="btn-primary">Agregar</button>
</form>
<div class="card overflow-x-auto">
  <table class="min-w-full text-sm">
    <thead class="bg-gray-100">
      <tr>
        <th class="p-2 text-left">Nombre</th>
        <th class="p-2 text-left">Identificador</th>
        <th class="p-2 text-left">Teléfono</th>
        <th class="p-2 text-left">Tipo</th>
        <th class="p-2 text-left">Acciones</th>
      </tr>
    </thead>
    <tbody>
    {% for c in clients.items %}
      <tr class="border-t">
        <td class="p-2">{{ c.name }}{% if c.last_name %} {{ c.last_name }}{% endif %}</td>
        <td class="p-2">{{ c.identifier|id_doc }}</td>
        <td class="p-2">{{ c.phone|phone }}</td>
        <td class="p-2">{{ 'Final' if c.is_final_consumer else 'Fiscal' }}</td>
        <td class="p-2 space-x-2">
          <a class="text-blue-500" href="{{ url_for('edit_client', client_id=c.id) }}">Editar</a>
          <form method="post" action="{{ url_for('delete_client', client_id=c.id) }}" class="inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="text-red-500" onclick="return confirm('¿Eliminar este cliente?')">Eliminar</button>
          </form>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
<div class="mt-4 flex items-center gap-2">
  {% if clients.has_prev %}
  <a href="?page={{ clients.prev_num }}&q={{ q }}" class="px-2 py-1 bg-gray-200 rounded">Anterior</a>
  {% endif %}
  <span>Página {{ clients.page }} de {{ clients.pages }}</span>
  {% if clients.has_next %}
  <a href="?page={{ clients.next_num }}&q={{ q }}" class="px-2 py-1 bg-gray-200 rounded">Siguiente</a>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
window.addEventListener('load', () => {
  const typeRadios=document.querySelectorAll('input[name="type"]');
  const idField=document.getElementById('identifier');
  const lastField=document.getElementById('last_name');
  const lastFieldWrapper=document.getElementById('last-name-wrapper');
  function toggle(){
    if(document.querySelector('input[name="type"]:checked').value==='final'){
      lastFieldWrapper.classList.remove('hidden');
      lastField.required=false;
      idField.placeholder='Cédula';
      idField.required=false;
      idField.dataset.docType='cedula';
    }else{
      lastFieldWrapper.classList.add('hidden');
      lastField.required=false;
      idField.placeholder='RNC *';
      idField.required=true;
      idField.dataset.docType='rnc';
    }
    applyDocMask(idField);
  }
  typeRadios.forEach(r=>r.addEventListener('change',toggle));
  toggle();
});
</script>
{% endblock %}

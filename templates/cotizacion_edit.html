{% extends 'base.html' %}
{% block title %}Editar Cotización{% endblock %}
{% block content %}
<h1 class="text-2xl font-semibold mb-4">Editar Cotización</h1>
<form method="post" id="quotation-form" class="space-y-6 card max-w-4xl mx-auto">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <div id="new-client" class="grid md:grid-cols-2 gap-4">
    <div>
      <label for="client-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
      <input name="client_name" value="{{ quotation.client.name }}" placeholder="Nombre" class="input" id="client-name" required>
    </div>
    <div>
      <label for="client-last" class="block text-sm font-medium text-gray-700 mb-1">Apellido</label>
      <input id="client-last" name="client_last_name" value="{{ quotation.client.last_name }}" placeholder="Apellido" class="input {{ '' if quotation.client.is_final_consumer else 'hidden' }}">
    </div>
    <div>
      <label for="client-identifier" class="block text-sm font-medium text-gray-700 mb-1">Documento</label>
      <input name="client_identifier" value="{{ quotation.client.identifier }}" placeholder="{{ 'Cédula' if quotation.client.is_final_consumer else 'RNC *' }}" class="input id-mask" id="client-identifier" data-doc-type="{{ 'cedula' if quotation.client.is_final_consumer else 'rnc' }}" {% if not quotation.client.is_final_consumer %}required{% endif %}>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
      <input name="client_phone" value="{{ quotation.client.phone }}" placeholder="Teléfono" class="input phone-mask">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Correo electrónico</label>
      <input name="client_email" value="{{ quotation.client.email }}" placeholder="Email" class="input">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Calle</label>
      <input name="client_street" value="{{ quotation.client.street }}" placeholder="Calle" class="input">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Sector</label>
      <input name="client_sector" value="{{ quotation.client.sector }}" placeholder="Sector" class="input">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Provincia</label>
      <input name="client_province" value="{{ quotation.client.province }}" placeholder="Provincia" class="input">
    </div>
    <div class="flex space-x-4 col-span-2">
      <label><input type="radio" name="client_type" value="final" {% if quotation.client.is_final_consumer %}checked{% endif %}> Consumidor Final</label>
      <label><input type="radio" name="client_type" value="fiscal" {% if not quotation.client.is_final_consumer %}checked{% endif %}> Comprobante Fiscal</label>
    </div>
  </div>
  <div class="grid md:grid-cols-4 gap-4">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Vendedor</label>
      <select name="seller" class="input" required>
        {% for s in sellers %}
        {% set full = s.first_name + (' ' + s.last_name if s.last_name else '') %}
        <option value="{{ full }}" {% if quotation.seller==full %}selected{% endif %}>{{ full }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="payment-method" class="block text-sm font-medium text-gray-700 mb-1">Método de pago</label>
      <select name="payment_method" id="payment-method" class="input">
        <option value="Efectivo" {% if quotation.payment_method=='Efectivo' %}selected{% endif %}>Efectivo</option>
        <option value="Transferencia" {% if quotation.payment_method=='Transferencia' %}selected{% endif %}>Transferencia bancaria</option>
      </select>
    </div>
    <div id="bank-field" class="{% if quotation.payment_method!='Transferencia' %}hidden{% endif %}">
      <label for="bank-select" class="block text-sm font-medium text-gray-700 mb-1">Banco</label>
      <select name="bank" id="bank-select" class="input">
        <option value="">Seleccione banco</option>
        <option {% if quotation.bank=='Banco Popular' %}selected{% endif %}>Banco Popular</option>
        <option {% if quotation.bank=='Banco BHD' %}selected{% endif %}>Banco BHD</option>
        <option {% if quotation.bank=='Banco Banreservas' %}selected{% endif %}>Banco Banreservas</option>
        <option {% if quotation.bank=='Banesco' %}selected{% endif %}>Banesco</option>
      </select>
    </div>
    <div>
      <label for="validity-period" class="block text-sm font-medium text-gray-700 mb-1">Vigencia</label>
      {% set validity_days = (quotation.valid_until - quotation.date).days if quotation.valid_until and quotation.date else 30 %}
      <select name="validity_period" id="validity-period" class="input">
        <option value="15d" {% if validity_days <= 15 %}selected{% endif %}>15 días</option>
        <option value="1m" {% if validity_days > 15 and validity_days <= 30 %}selected{% endif %}>1 mes</option>
        <option value="2m" {% if validity_days > 30 and validity_days <= 60 %}selected{% endif %}>2 meses</option>
        <option value="3m" {% if validity_days > 60 %}selected{% endif %}>3 meses</option>
      </select>
    </div>
  </div>
  <div>
    <h2 class="text-xl font-semibold mb-2">Productos</h2>
    <div class="hidden sm:grid sm:grid-cols-6 gap-2 mb-2 text-xs font-semibold uppercase tracking-wide text-gray-500">
      <span>Producto</span>
      <span>Unidad</span>
      <span>Precio</span>
      <span>Cantidad</span>
      <span>Descuento</span>
      <span>Acción</span>
    </div>
    <div id="productos">
      {% for it in items %}
      <div class="grid grid-cols-1 sm:grid-cols-6 gap-2 mb-2 product-row">
        <select name="product_id[]" class="input product-select">
          <option value="">Seleccione...</option>
          {% for p in products %}
          <option value="{{ p.id }}" data-unit="{{ p.unit }}" data-price="{{ p.price }}" {% if it.product_id == p.id %}selected{% endif %}>{{ p.code }} - {{ p.name }}</option>
          {% endfor %}
        </select>
        <input class="input unit-field" value="{{ it.unit }}" placeholder="Unidad" readonly>
        <input class="input price-field" value="{{ '%.2f'|format(it.price) }}" placeholder="Precio" readonly>
        <input name="product_quantity[]" value="{{ it.quantity }}" placeholder="Cantidad" class="input" required>
        <input name="product_discount[]" value="{{ '%.2f'|format(it.discount) }}" placeholder="Desc. %" class="input">
        <button type="button" class="btn-secondary remove-product">Eliminar</button>
      </div>
      {% endfor %}
    </div>
    <button type="button" id="add-product" class="btn-secondary mt-2">Agregar Producto</button>
  </div>
  <div>
    <label for="edit-quotation-note" class="block text-sm font-medium text-gray-700 mb-1">Nota</label>
    <textarea id="edit-quotation-note" name="note" class="input w-full" placeholder="Nota">{{ quotation.note }}</textarea>
  </div>
  <button class="btn-primary">Guardar</button>
</form>
{% endblock %}

{% block scripts %}
<script>
window.addEventListener('load', () => {
  const productContainer = document.getElementById('productos');
  const typeRadios=document.querySelectorAll('input[name="client_type"]');
  const idField=document.getElementById('client-identifier');
  const lastField=document.getElementById('client-last');
  function toggleType(){
    if(document.querySelector('input[name="client_type"]:checked').value==='final'){
      lastField.classList.remove('hidden');
      lastField.required=false;
      idField.placeholder='Cédula';
      idField.required=false;
      idField.dataset.docType='cedula';
    }else{
      lastField.classList.add('hidden');
      lastField.required=false;
      idField.placeholder='RNC *';
      idField.required=true;
      idField.dataset.docType='rnc';
    }
    applyDocMask(idField);
  }
  typeRadios.forEach(r=>r.addEventListener('change',toggleType));
  toggleType();

  const paySelect=document.getElementById('payment-method');
  const bankField=document.getElementById('bank-field');
  paySelect.addEventListener('change',()=>{
    bankField.classList.toggle('hidden', paySelect.value!=='Transferencia');
  });

  function bindProduct(row) {
    const select = row.querySelector('.product-select');
    const unit = row.querySelector('.unit-field');
    const price = row.querySelector('.price-field');
    const removeBtn = row.querySelector('.remove-product');
    select.addEventListener('change', function() {
      const opt = this.selectedOptions[0];
      unit.value = opt.dataset.unit || '';
      price.value = opt.dataset.price ? parseFloat(opt.dataset.price).toFixed(2) : '';
    });
    removeBtn.addEventListener('click', () => {
      row.remove();
    });
  }

  const templateRow = document.createElement('div');
  templateRow.className = 'grid grid-cols-1 sm:grid-cols-6 gap-2 mb-2 product-row';
  templateRow.innerHTML = `
    <select name="product_id[]" class="input product-select">
      <option value="">Seleccione...</option>
      {% for p in products %}
      <option value="{{ p.id }}" data-unit="{{ p.unit }}" data-price="{{ p.price }}">{{ p.code }} - {{ p.name }}</option>
      {% endfor %}
    </select>
    <input class="input unit-field" placeholder="Unidad" readonly>
    <input class="input price-field" placeholder="Precio" readonly>
    <input name="product_quantity[]" placeholder="Cantidad" class="input" required>
    <input name="product_discount[]" placeholder="Desc. %" class="input">
    <button type="button" class="btn-secondary remove-product">Eliminar</button>`;

  function addProductRow() {
    const row = templateRow.cloneNode(true);
    productContainer.appendChild(row);
    bindProduct(row);
  }

  document.getElementById('add-product').addEventListener('click', addProductRow);

  document.querySelectorAll('.product-row').forEach(bindProduct);
  toggleType();
});
</script>
{% endblock %}
